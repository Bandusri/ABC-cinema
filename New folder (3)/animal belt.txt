#include <Wire.h>
#include <FirebaseESP32.h>
#include <DHT.h>
#include <MPU6050_tockn.h>
#include <TinyGPS++.h>

#define FIREBASE_HOST "YOUR_FIREBASE_HOST"
#define FIREBASE_AUTH "YOUR_FIREBASE_AUTH_TOKEN"
#define DHTPIN 23
#define DHTTYPE DHT11
#define RAIN_PIN 32
#define RX_PIN 16
#define TX_PIN 17

const char* ssid = "YOUR_WIFI_SSID";
const char* password = "YOUR_WIFI_PASSWORD";

FirebaseData firebaseData;
DHT dht(DHTPIN, DHTTYPE);
MPU6050 mpu6050(Wire);
TinyGPSPlus gps;

void setup() {
  Serial.begin(9600);

  Wire.begin();
  mpu6050.begin();
  dht.begin();
  pinMode(RAIN_PIN, INPUT);

  WiFi.begin(ssid, password);

  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.println("Connecting to WiFi...");
  }

  Firebase.begin(FIREBASE_HOST, FIREBASE_AUTH);
}

void loop() {
  // Read sensor data
  float temperature = dht.readTemperature();
  float humidity = dht.readHumidity();

  // Read MPU6050 sensor data
  float ax = mpu6050.getAccX();
  float ay = mpu6050.getAccY();
  float az = mpu6050.getAccZ();
  float gx = mpu6050.getGyroX();
  float gy = mpu6050.getGyroY();
  float gz = mpu6050.getGyroZ();

  // Read rain sensor value
  int rainValue = digitalRead(RAIN_PIN);

  // Read GPS data
  float latitude = 0.0;
  float longitude = 0.0;

  while (gps.charsProcessed() < 100) {
    if (gps.encode(Serial.read())) {
      if (gps.location.isValid()) {
        latitude = gps.location.lat();
        longitude = gps.location.lng();
        break;
      }
    }
  }

  // Update Firebase data
  Firebase.setFloat(firebaseData, "/temperature", temperature);
  Firebase.setFloat(firebaseData, "/humidity", humidity);
  Firebase.setFloat(firebaseData, "/accelerometer/x", ax);
  Firebase.setFloat(firebaseData, "/accelerometer/y", ay);
  Firebase.setFloat(firebaseData, "/accelerometer/z", az);
  Firebase.setFloat(firebaseData, "/gyroscope/x", gx);
  Firebase.setFloat(firebaseData, "/gyroscope/y", gy);
  Firebase.setFloat(firebaseData, "/gyroscope/z", gz);
  Firebase.setInt(firebaseData, "/rain", rainValue);
  Firebase.setFloat(firebaseData, "/latitude", latitude);
  Firebase.setFloat(firebaseData, "/longitude", longitude);

  if (Firebase.failed()) {
    Serial.println("Firebase update failed.");
  } else {
    Serial.println("Firebase update success.");
  }

  delay(1000);
}